function T = dj_uncertainflashinference_trialtable(bpodstruct, name)
% This function returns the trial table from a Bpod structure generated by
% the UncertainFlashInference protocol.
% 
% Maxime Maheu <maheu.mp@gmail.com> | 2024

% Define labels
tasklabels = {'count', 'weigh'};
portlabels = {'left', 'middle', 'right'};
pairlabels = {'none', 'miniblock', 'replay'};

% Specify the date-time format
dtformat = 'yyyy-MM-dd HH:mm:ss';
dtfun = @(x) char(datetime(x, 'Format', dtformat));

% Loop over trials
Ntrials = bpodstruct.nTrials;
T = struct;
for i = 1:Ntrials
    
    % Get info corresponding to current trial
    settings = bpodstruct.TrialSettings(i);
    states = bpodstruct.RawEvents.Trial{i}.States;
    
    % Get choice and timings
    [choice, outcome, timepoke] = getdecisionlabels(states);
    if     isfield(states, 'SideCue'), timeon = states.SideCue(1);
    elseif isfield(states, 'Flash1'),  timeon = states.Flash1(1);
    end
    
    % Labels for generative categories
    gencat = [-1,1];
    gencatlabels = {'left', 'right'};
    
    % Build table
    T(i).name               = name;
    T(i).trial_datetime     = dtfun(settings.InitTimeTrial);
    % ---------------------------------------------------------------------
    T(i).run_datetime       = dtfun(settings.RunOnset);
    T(i).session_datetime   = dtfun([bpodstruct.Info.SessionDate ' ' bpodstruct.Info.SessionStartTime_UTC]);
    T(i).trial              = i;
    T(i).isday              = settings.IsDay;
    % ---------------------------------------------------------------------
    T(i).label              = settings.Label;
    T(i).task               = tasklabels{settings.Design + 1};
    T(i).stage              = settings.Stage;
    T(i).trial_instage      = settings.StageTrials;
    % ---------------------------------------------------------------------
    T(i).init_time          = seconds(settings.InitTimeTrial - settings.InitTimeFixation);
    T(i).flashes_left       = strjoin(arrayfun(@num2str, settings.Trial(1,:), 'uni', 0), ' ');
    T(i).flashes_right      = strjoin(arrayfun(@num2str, settings.Trial(2,:), 'uni', 0), ' ');
    T(i).generative_side    = gencatlabels{settings.CatGen == gencat};
    T(i).correct_side       = portlabels{settings.SideCorrect};
    T(i).choice             = choice;
    T(i).outcome            = outcome;
    T(i).rt                 = max([timepoke - timeon, -1], [], 'OmitNaN');
    % ---------------------------------------------------------------------
    T(i).ispaired           = settings.PairedTrial;
    T(i).pairedstrat        = pairlabels{settings.PairedStrategy + 1};
    T(i).paired_inittime    = dtfun(settings.PairedInitTime);
    % ---------------------------------------------------------------------
    T(i).isstaircase        = settings.StaircaseTrial;
    T(i).staircase_nightval = settings.StaircaseVal{1}(end);
    T(i).staircase_dayval   = settings.StaircaseVal{2}(end);
    % ---------------------------------------------------------------------
    T(i).tau                = settings.Tau;
    T(i).alpha              = settings.Alpha;
    T(i).sigma              = settings.Sigma;
end
end

% =========================================================================
% Subfunction to get choice & outcome labels from Bpod trial structure
function [choice, outcome, timepoke] = getdecisionlabels(trialstruc)

% Define detection variable
ports   = [1 3];
correct = arrayfun(@(x) sprintf('Correct%i',    x), ports, 'uni', 0);
error   = arrayfun(@(x) sprintf('Error%i',      x), ports, 'uni', 0);
early   = arrayfun(@(x) sprintf('EarlyEnter%i', x), ports, 'uni', 0);
fun     = @(x,y) any(~isnan([x, y]));

% Get boolean categories
isleft       = fun(trialstruc.(correct{1}), trialstruc.(error  {1}));
isright      = fun(trialstruc.(correct{2}), trialstruc.(error  {2}));
isleftearly  = fun(trialstruc.(early{1}), []);
isrightearly = fun(trialstruc.(early{2}), []);
isearly      = isleftearly | isrightearly;
iscorrect    = fun(trialstruc.(correct{1}), trialstruc.(correct{2}));
isomitted    = all(cellfun(@(x) all(isnan(trialstruc.(x))), [correct, error, early]));

% Determine choice label
if isleft,       choice = 'left';       end
if isright,      choice = 'right';      end
if isleftearly,  choice = 'earlyleft';  end
if isrightearly, choice = 'earlyright'; end
if isomitted,    choice = 'omission';   end

% Determine outcome label
if  iscorrect, outcome = 'correct';  end
if ~iscorrect, outcome = 'error';    end
if  isearly,   outcome = 'early';    end
if  isomitted, outcome = 'omission'; end

% Get timing of decision poke
timepoke = cellfun(@(x) trialstruc.(x)(1), [correct, error, early]);
timepoke = timepoke(~isnan(timepoke));
end